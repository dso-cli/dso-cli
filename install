#!/usr/bin/env bash
# Universal DSO Installation Script
# Works on: macOS, Linux (Ubuntu/Debian/Other), Windows (via Git Bash/WSL)
# Usage: curl -fsSL https://raw.githubusercontent.com/dso-cli/dso-cli/main/install | bash
# Or: ./install

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Detect OS
detect_os() {
    case "$(uname -s)" in
        Linux*)     echo "linux" ;;
        Darwin*)    echo "darwin" ;;
        MINGW*|MSYS*|CYGWIN*) echo "windows" ;;
        *)          echo "unknown" ;;
    esac
}

OS=$(detect_os)
ARCH=$(uname -m)

echo -e "${BLUE}üîí DSO - DevSecOps Oracle${NC}"
echo -e "${BLUE}Universal Installation Script${NC}"
echo ""
echo -e "Detected: ${GREEN}$OS${NC} on ${GREEN}$ARCH${NC}"
echo ""

# Check if running as root (not recommended)
if [ "$EUID" -eq 0 ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  Warning: Running as root. Consider running as regular user.${NC}"
    read -p "Continue? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# Function to check if command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Function to install Go
install_go() {
    echo -e "${YELLOW}üì¶ Installing Go...${NC}"
    
    case "$OS" in
        darwin)
            if command_exists brew; then
                brew install go
            else
                echo -e "${RED}‚ùå Homebrew not found. Please install Homebrew first:${NC}"
                echo "   /bin/bash -c \"\$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)\""
                exit 1
            fi
            ;;
        linux)
            if [ -f /etc/debian_version ]; then
                # Debian/Ubuntu
                echo -e "${BLUE}Installing Go via apt...${NC}"
                sudo apt-get update
                sudo apt-get install -y golang-go
            elif [ -f /etc/redhat-release ]; then
                # RHEL/CentOS/Fedora
                echo -e "${BLUE}Installing Go via dnf/yum...${NC}"
                if command_exists dnf; then
                    sudo dnf install -y golang
                else
                    sudo yum install -y golang
                fi
            elif [ -f /etc/arch-release ]; then
                # Arch Linux
                echo -e "${BLUE}Installing Go via pacman...${NC}"
                sudo pacman -S --noconfirm go
            elif command_exists snap; then
                # Snap fallback
                echo -e "${BLUE}Installing Go via snap...${NC}"
                sudo snap install go --classic
            else
                echo -e "${YELLOW}‚ö†Ô∏è  Please install Go manually: https://go.dev/doc/install${NC}"
                echo -e "${YELLOW}   Or use the official installer script:${NC}"
                echo "   curl -fsSL https://go.dev/dl/go1.21.linux-amd64.tar.gz | sudo tar -xzC /usr/local"
                exit 1
            fi
            ;;
        windows)
            if command_exists winget; then
                echo -e "${BLUE}Installing Go via winget...${NC}"
                winget install GoLang.Go
            elif command_exists scoop; then
                echo -e "${BLUE}Installing Go via scoop...${NC}"
                scoop install go
            else
                echo -e "${YELLOW}‚ö†Ô∏è  Please install Go manually: https://go.dev/doc/install${NC}"
                echo "   Or install winget/scoop first, then run this script again"
                exit 1
            fi
            ;;
    esac
    
    if command_exists go; then
        echo -e "${GREEN}‚úÖ Go installed: $(go version)${NC}"
    else
        echo -e "${RED}‚ùå Go installation failed${NC}"
        exit 1
    fi
}

# Function to install Ollama
install_ollama() {
    echo -e "${YELLOW}üì¶ Installing Ollama...${NC}"
    
    if command_exists ollama; then
        echo -e "${GREEN}‚úÖ Ollama already installed${NC}"
        return
    fi
    
    case "$OS" in
        darwin)
            if command_exists brew; then
                echo -e "${BLUE}Installing Ollama via Homebrew...${NC}"
                brew install ollama
            else
                echo -e "${YELLOW}Installing Ollama manually...${NC}"
                curl -fsSL https://ollama.ai/install.sh | sh
            fi
            ;;
        linux)
            echo -e "${BLUE}Installing Ollama...${NC}"
            curl -fsSL https://ollama.ai/install.sh | sh
            ;;
        windows)
            if command_exists winget; then
                echo -e "${BLUE}Installing Ollama via winget...${NC}"
                winget install Ollama.Ollama
            elif command_exists scoop; then
                echo -e "${BLUE}Installing Ollama via scoop...${NC}"
                scoop install ollama
            else
                echo -e "${YELLOW}‚ö†Ô∏è  Please install Ollama manually:${NC}"
                echo "   Download from: https://ollama.ai"
                echo "   Or use: winget install Ollama.Ollama"
                return
            fi
            ;;
    esac
    
    if command_exists ollama; then
        echo -e "${GREEN}‚úÖ Ollama installed${NC}"
        
        # Start Ollama service
        case "$OS" in
            darwin)
                if ! pgrep -x "ollama" > /dev/null; then
                    echo -e "${YELLOW}üöÄ Starting Ollama...${NC}"
                    brew services start ollama 2>/dev/null || ollama serve &
                    sleep 3
                fi
                ;;
            linux)
                if ! pgrep -x "ollama" > /dev/null; then
                    echo -e "${YELLOW}üöÄ Starting Ollama...${NC}"
                    systemctl --user start ollama 2>/dev/null || ollama serve &
                    sleep 3
                fi
                ;;
            windows)
                echo -e "${YELLOW}üöÄ Please start Ollama manually or it will start automatically${NC}"
                ;;
        esac
    else
        echo -e "${YELLOW}‚ö†Ô∏è  Ollama installation may have failed. Please install manually.${NC}"
    fi
}

# Function to select and download Ollama models
select_and_download_models() {
    if ! command_exists ollama; then
        echo -e "${YELLOW}‚ö†Ô∏è  Ollama not available. Install it first.${NC}"
        return
    fi
    
    echo -e "${BLUE}ü§ñ Available AI Models:${NC}"
    echo ""
    echo "  1) llama3.1:8b      (~4.7 GB) - Recommended, balanced performance"
    echo "  2) llama3.1:70b     (~40 GB)  - Best quality, requires more RAM"
    echo "  3) phi3              (~2.3 GB) - Lightweight, fast"
    echo "  4) mistral:7b        (~4.1 GB) - Good balance"
    echo "  5) gemma:7b          (~5.2 GB) - Google's model"
    echo "  6) qwen2.5:7b        (~4.7 GB) - High quality"
    echo "  7) All recommended  (llama3.1:8b, phi3)"
    echo "  8) Skip model installation"
    echo ""
    
    read -p "Select model(s) to install (1-8, multiple separated by space): " -r
    echo
    
    SELECTED_MODELS=""
    
    for choice in $REPLY; do
        case $choice in
            1)
                SELECTED_MODELS="$SELECTED_MODELS llama3.1:8b"
                ;;
            2)
                SELECTED_MODELS="$SELECTED_MODELS llama3.1:70b"
                ;;
            3)
                SELECTED_MODELS="$SELECTED_MODELS phi3"
                ;;
            4)
                SELECTED_MODELS="$SELECTED_MODELS mistral:7b"
                ;;
            5)
                SELECTED_MODELS="$SELECTED_MODELS gemma:7b"
                ;;
            6)
                SELECTED_MODELS="$SELECTED_MODELS qwen2.5:7b"
                ;;
            7)
                SELECTED_MODELS="$SELECTED_MODELS llama3.1:8b phi3"
                ;;
            8)
                echo -e "${YELLOW}‚è≠Ô∏è  Skipping model installation${NC}"
                echo -e "${BLUE}   You can install models later with: ollama pull <model-name>${NC}"
                return
                ;;
            *)
                echo -e "${YELLOW}‚ö†Ô∏è  Invalid choice: $choice${NC}"
                ;;
        esac
    done
    
    if [ -z "$SELECTED_MODELS" ]; then
        echo -e "${YELLOW}‚è≠Ô∏è  No models selected${NC}"
        return
    fi
    
    # Set default model if not set
    if [ -z "$DSO_MODEL" ]; then
        # Use first selected model as default
        FIRST_MODEL=$(echo $SELECTED_MODELS | awk '{print $1}')
        export DSO_MODEL="$FIRST_MODEL"
        echo -e "${BLUE}üìå Default model set to: $DSO_MODEL${NC}"
        echo -e "${BLUE}   (You can change it with: export DSO_MODEL=<model-name>)${NC}"
        echo ""
    fi
    
    # Download selected models
    for model in $SELECTED_MODELS; do
        echo -e "${YELLOW}üì• Downloading model: $model${NC}"
        
        # Check model size info
        case $model in
            llama3.1:8b)
                echo -e "${BLUE}   Size: ~4.7 GB${NC}"
                ;;
            llama3.1:70b)
                echo -e "${BLUE}   Size: ~40 GB (this may take a while)${NC}"
                ;;
            phi3)
                echo -e "${BLUE}   Size: ~2.3 GB${NC}"
                ;;
            mistral:7b)
                echo -e "${BLUE}   Size: ~4.1 GB${NC}"
                ;;
            gemma:7b)
                echo -e "${BLUE}   Size: ~5.2 GB${NC}"
                ;;
            qwen2.5:7b)
                echo -e "${BLUE}   Size: ~4.7 GB${NC}"
                ;;
        esac
        
        ollama pull "$model" || {
            echo -e "${YELLOW}‚ö†Ô∏è  Model $model download failed. You can download it later with:${NC}"
            echo "   ollama pull $model"
        }
        echo ""
    done
    
    echo -e "${GREEN}‚úÖ Model installation completed${NC}"
}

# Function to download Ollama model (legacy, for non-interactive)
download_model() {
    MODEL=${DSO_MODEL:-llama3.1:8b}
    echo -e "${YELLOW}üì• Downloading AI model: $MODEL${NC}"
    echo -e "${YELLOW}   This may take a few minutes...${NC}"
    
    if command_exists ollama; then
        ollama pull "$MODEL" || {
            echo -e "${YELLOW}‚ö†Ô∏è  Model download failed. You can download it later with:${NC}"
            echo "   ollama pull $MODEL"
        }
    else
        echo -e "${YELLOW}‚ö†Ô∏è  Ollama not available. Install it first, then run:${NC}"
        echo "   ollama pull $MODEL"
    fi
}

# Function to install security tools
install_security_tools() {
    echo -e "${YELLOW}üîß Installing security tools (optional but recommended)...${NC}"
    
    INSTALL_TOOLS=false
    if [ "$1" = "--with-tools" ]; then
        INSTALL_TOOLS=true
    else
        read -p "Install security tools (Trivy, gitleaks, etc.)? (y/N): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            INSTALL_TOOLS=true
        fi
    fi
    
    if [ "$INSTALL_TOOLS" = false ]; then
        echo -e "${YELLOW}‚è≠Ô∏è  Skipping tool installation. You can install them later with:${NC}"
        echo "   dso tools --install"
        return
    fi
    
    case "$OS" in
        darwin)
            if command_exists brew; then
                echo -e "${BLUE}Installing via Homebrew...${NC}"
                brew install trivy gitleaks || true
                brew install grype tfsec || true
            fi
            ;;
        linux)
            if [ -f /etc/debian_version ]; then
                # Trivy
                echo -e "${BLUE}Installing Trivy...${NC}"
                sudo apt-get update
                sudo apt-get install -y wget apt-transport-https gnupg lsb-release || true
                wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add - || true
                echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee /etc/apt/sources.list.d/trivy.list || true
                sudo apt-get update
                sudo apt-get install -y trivy || true
                
                # gitleaks
                echo -e "${BLUE}Installing gitleaks...${NC}"
                GITLEAKS_VERSION=$(curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest | grep tag_name | cut -d '"' -f 4)
                wget "https://github.com/gitleaks/gitleaks/releases/download/${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz" -O /tmp/gitleaks.tar.gz || true
                tar -xzf /tmp/gitleaks.tar.gz -C /tmp gitleaks || true
                sudo mv /tmp/gitleaks /usr/local/bin/ && sudo chmod +x /usr/local/bin/gitleaks || true
                
                # Grype
                echo -e "${BLUE}Installing Grype...${NC}"
                curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin || true
            else
                # Generic Linux
                echo -e "${BLUE}Installing via install scripts...${NC}"
                curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin || true
                curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin || true
            fi
            ;;
        windows)
            echo -e "${YELLOW}‚ö†Ô∏è  Please install tools manually:${NC}"
            echo "   scoop install trivy grype gitleaks tfsec"
            echo "   Or: winget install AquaSecurity.Trivy"
            ;;
    esac
    
    echo -e "${GREEN}‚úÖ Security tools installation attempted${NC}"
}

# Function to build DSO
build_dso() {
    echo -e "${YELLOW}üî® Building DSO...${NC}"
    
    if [ ! -f "go.mod" ]; then
        echo -e "${RED}‚ùå Not in DSO directory. Please run from the DSO repository root.${NC}"
        exit 1
    fi
    
    # Remove old binary if exists
    if [ -f "dso" ]; then
        echo -e "${BLUE}Removing old binary...${NC}"
        rm -f dso
    fi
    if [ -f "dso.exe" ]; then
        echo -e "${BLUE}Removing old binary...${NC}"
        rm -f dso.exe
    fi
    
    # Set build variables
    export CGO_ENABLED=0
    
    case "$OS" in
        darwin)
            if [ "$ARCH" = "arm64" ]; then
                GOOS=darwin GOARCH=arm64 go build -o dso .
            else
                GOOS=darwin GOARCH=amd64 go build -o dso .
            fi
            ;;
        linux)
            if [ "$ARCH" = "aarch64" ] || [ "$ARCH" = "arm64" ]; then
                GOOS=linux GOARCH=arm64 go build -o dso .
            else
                GOOS=linux GOARCH=amd64 go build -o dso .
            fi
            ;;
        windows)
            GOOS=windows GOARCH=amd64 go build -o dso.exe .
            ;;
    esac
    
    if [ -f "dso" ] || [ -f "dso.exe" ]; then
        chmod +x dso 2>/dev/null || true
        echo -e "${GREEN}‚úÖ DSO built successfully${NC}"
    else
        echo -e "${RED}‚ùå Build failed${NC}"
        exit 1
    fi
}

# Function to install DSO globally
install_globally() {
    INSTALL_GLOBAL=false
    read -p "Install DSO globally? (y/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        INSTALL_GLOBAL=true
    fi
    
    if [ "$INSTALL_GLOBAL" = false ]; then
        echo -e "${YELLOW}‚è≠Ô∏è  Skipping global installation${NC}"
        return
    fi
    
    case "$OS" in
        darwin|linux)
            if [ -f "dso" ]; then
                # Remove old version if exists
                if [ -f "/usr/local/bin/dso" ]; then
                    echo -e "${BLUE}Removing old global installation...${NC}"
                    sudo rm -f /usr/local/bin/dso 2>/dev/null || true
                fi
                if [ -f "$HOME/go/bin/dso" ]; then
                    rm -f "$HOME/go/bin/dso" 2>/dev/null || true
                fi
                if [ -f "$HOME/.local/bin/dso" ]; then
                    rm -f "$HOME/.local/bin/dso" 2>/dev/null || true
                fi
                
                # Install new version
                sudo cp dso /usr/local/bin/ 2>/dev/null || cp dso "$HOME/go/bin/" 2>/dev/null || cp dso "$HOME/.local/bin/" 2>/dev/null
                sudo chmod +x /usr/local/bin/dso 2>/dev/null || chmod +x "$HOME/go/bin/dso" 2>/dev/null || chmod +x "$HOME/.local/bin/dso" 2>/dev/null
                echo -e "${GREEN}‚úÖ DSO installed globally${NC}"
                echo -e "${BLUE}   Run: dso --version${NC}"
            fi
            ;;
        windows)
            echo -e "${YELLOW}‚ö†Ô∏è  Please add dso.exe to your PATH manually${NC}"
            ;;
    esac
}

# Main installation flow
main() {
    # Check if we're in the right directory
    if [ ! -f "main.go" ] && [ ! -f "go.mod" ]; then
        echo -e "${YELLOW}üì• Cloning DSO repository...${NC}"
        if command_exists git; then
            # Remove old installation if exists
            if [ -d "/tmp/dso-install" ]; then
                echo -e "${BLUE}Removing previous installation...${NC}"
                rm -rf /tmp/dso-install
            fi
            git clone https://github.com/dso-cli/dso-cli.git /tmp/dso-install
            cd /tmp/dso-install
        else
            echo -e "${RED}‚ùå Git not found. Please install git first.${NC}"
            exit 1
        fi
    else
        # We're in the repo, update to latest
        if command_exists git && [ -d ".git" ]; then
            echo -e "${BLUE}üì• Updating to latest version...${NC}"
            git fetch origin
            git pull origin main 2>/dev/null || git pull origin master 2>/dev/null || true
        fi
    fi
    
    # Step 1: Check/Install Go
    if ! command_exists go; then
        install_go
    else
        echo -e "${GREEN}‚úÖ Go found: $(go version)${NC}"
    fi
    echo ""
    
    # Step 2: Download dependencies and build DSO
    echo -e "${YELLOW}üì¶ Downloading Go dependencies...${NC}"
    go mod download
    go mod tidy
    echo -e "${GREEN}‚úÖ Dependencies downloaded${NC}"
    echo ""
    
    build_dso
    echo ""
    
    # Step 3: Check/Install Ollama
    if ! command_exists ollama; then
        install_ollama
    else
        echo -e "${GREEN}‚úÖ Ollama found${NC}"
    fi
    echo ""
    
    # Step 4: Download models (interactive)
    if command_exists ollama; then
        # Check if any models are already installed
        INSTALLED_MODELS=$(ollama list 2>/dev/null | tail -n +2 | awk '{print $1}' || echo "")
        
        if [ -n "$INSTALLED_MODELS" ]; then
            echo -e "${GREEN}‚úÖ Installed models:${NC}"
            echo "$INSTALLED_MODELS" | while read model; do
                echo -e "   ‚Ä¢ $model"
            done
            echo ""
            read -p "Install additional models? (y/N): " -n 1 -r
            echo
            if [[ $REPLY =~ ^[Yy]$ ]]; then
                select_and_download_models
            else
                # Set default model if not set
                if [ -z "$DSO_MODEL" ]; then
                    FIRST_MODEL=$(echo "$INSTALLED_MODELS" | head -1)
                    export DSO_MODEL="$FIRST_MODEL"
                    echo -e "${BLUE}üìå Using model: $DSO_MODEL${NC}"
                fi
            fi
        else
            echo -e "${YELLOW}No models installed. Installing default model: qwen2.5:7b${NC}"
            DEFAULT_MODEL="qwen2.5:7b"
            
            # Save default model to config
            mkdir -p "$HOME/.dso"
            echo "DSO_MODEL=$DEFAULT_MODEL" > "$HOME/.dso/config"
            echo -e "${BLUE}üìå Default model set to: $DEFAULT_MODEL${NC}"
            echo ""
            
            # Download the default model
            echo -e "${YELLOW}üì• Downloading model: $DEFAULT_MODEL${NC}"
            echo -e "${BLUE}   Size: ~4.7 GB${NC}"
            echo -e "${BLUE}   This may take a few minutes...${NC}"
            echo ""
            
            ollama pull "$DEFAULT_MODEL" || {
                echo -e "${YELLOW}‚ö†Ô∏è  Model download failed. You can download it later with:${NC}"
                echo "   ollama pull $DEFAULT_MODEL"
                echo ""
                echo -e "${BLUE}üí° You can also select models interactively by running:${NC}"
                echo "   dso check"
            }
            
            if ollama list 2>/dev/null | grep -q "$DEFAULT_MODEL"; then
                echo -e "${GREEN}‚úÖ Model $DEFAULT_MODEL installed successfully${NC}"
            fi
        fi
    fi
    echo ""
    
    # Step 5: Install security tools (optional)
    install_security_tools "$@"
    echo ""
    
    # Step 6: Global installation (optional)
    install_globally
    echo ""
    
    # Final message
    echo -e "${GREEN}üéâ Installation completed!${NC}"
    echo ""
    echo -e "${BLUE}To use DSO:${NC}"
    if [ -f "dso" ]; then
        echo -e "  ${GREEN}./dso audit .${NC}"
    elif [ -f "dso.exe" ]; then
        echo -e "  ${GREEN}.\dso.exe audit .${NC}"
    fi
    echo ""
    echo -e "${BLUE}Verify installation:${NC}"
    echo -e "  ${GREEN}./dso check${NC}        # Check Ollama"
    echo -e "  ${GREEN}./dso tools${NC}       # Check scanners"
    echo ""
}

# Run main function
main "$@"

