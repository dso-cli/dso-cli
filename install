#!/usr/bin/env bash
# Universal DSO Installation Script
# Works on: macOS, Linux (Ubuntu/Debian/Other), Windows (via Git Bash/WSL)
# Usage: curl -fsSL https://raw.githubusercontent.com/dso-cli/dso-cli/main/install | bash
# Or: ./install

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Detect OS
detect_os() {
    case "$(uname -s)" in
        Linux*)     echo "linux" ;;
        Darwin*)    echo "darwin" ;;
        MINGW*|MSYS*|CYGWIN*) echo "windows" ;;
        *)          echo "unknown" ;;
    esac
}

OS=$(detect_os)
ARCH=$(uname -m)

echo -e "${BLUE}ðŸ”’ DSO - DevSecOps Oracle${NC}"
echo -e "${BLUE}Universal Installation Script${NC}"
echo ""
echo -e "Detected: ${GREEN}$OS${NC} on ${GREEN}$ARCH${NC}"
echo ""

# Check if running as root (not recommended)
if [ "$EUID" -eq 0 ]; then
    echo -e "${YELLOW}âš ï¸  Warning: Running as root. Consider running as regular user.${NC}"
    read -p "Continue? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# Function to check if command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Function to install Go
install_go() {
    echo -e "${YELLOW}ðŸ“¦ Installing Go...${NC}"
    
    case "$OS" in
        darwin)
            if command_exists brew; then
                brew install go
            else
                echo -e "${RED}âŒ Homebrew not found. Please install Homebrew first:${NC}"
                echo "   /bin/bash -c \"\$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)\""
                exit 1
            fi
            ;;
        linux)
            if [ -f /etc/debian_version ]; then
                # Debian/Ubuntu
                echo -e "${BLUE}Installing Go via apt...${NC}"
                sudo apt-get update
                sudo apt-get install -y golang-go
            elif [ -f /etc/redhat-release ]; then
                # RHEL/CentOS/Fedora
                echo -e "${BLUE}Installing Go via dnf/yum...${NC}"
                if command_exists dnf; then
                    sudo dnf install -y golang
                else
                    sudo yum install -y golang
                fi
            elif [ -f /etc/arch-release ]; then
                # Arch Linux
                echo -e "${BLUE}Installing Go via pacman...${NC}"
                sudo pacman -S --noconfirm go
            elif command_exists snap; then
                # Snap fallback
                echo -e "${BLUE}Installing Go via snap...${NC}"
                sudo snap install go --classic
            else
                echo -e "${YELLOW}âš ï¸  Please install Go manually: https://go.dev/doc/install${NC}"
                echo -e "${YELLOW}   Or use the official installer script:${NC}"
                echo "   curl -fsSL https://go.dev/dl/go1.21.linux-amd64.tar.gz | sudo tar -xzC /usr/local"
                exit 1
            fi
            ;;
        windows)
            if command_exists winget; then
                echo -e "${BLUE}Installing Go via winget...${NC}"
                winget install GoLang.Go
            elif command_exists scoop; then
                echo -e "${BLUE}Installing Go via scoop...${NC}"
                scoop install go
            else
                echo -e "${YELLOW}âš ï¸  Please install Go manually: https://go.dev/doc/install${NC}"
                echo "   Or install winget/scoop first, then run this script again"
                exit 1
            fi
            ;;
    esac
    
    if command_exists go; then
        echo -e "${GREEN}âœ… Go installed: $(go version)${NC}"
    else
        echo -e "${RED}âŒ Go installation failed${NC}"
        exit 1
    fi
}

# Function to install Ollama
install_ollama() {
    echo -e "${YELLOW}ðŸ“¦ Installing Ollama...${NC}"
    
    if command_exists ollama; then
        echo -e "${GREEN}âœ… Ollama already installed${NC}"
        return
    fi
    
    case "$OS" in
        darwin)
            if command_exists brew; then
                brew install ollama
            else
                echo -e "${YELLOW}âš ï¸  Installing Ollama manually...${NC}"
                curl -fsSL https://ollama.ai/install.sh | sh
            fi
            ;;
        linux)
            curl -fsSL https://ollama.ai/install.sh | sh
            ;;
        windows)
            echo -e "${YELLOW}âš ï¸  Please install Ollama manually:${NC}"
            echo "   Download from: https://ollama.ai"
            echo "   Or use: winget install Ollama.Ollama"
            return
            ;;
    esac
    
    if command_exists ollama; then
        echo -e "${GREEN}âœ… Ollama installed${NC}"
        
        # Start Ollama service
        case "$OS" in
            darwin)
                if ! pgrep -x "ollama" > /dev/null; then
                    echo -e "${YELLOW}ðŸš€ Starting Ollama...${NC}"
                    brew services start ollama 2>/dev/null || ollama serve &
                    sleep 3
                fi
                ;;
            linux)
                if ! pgrep -x "ollama" > /dev/null; then
                    echo -e "${YELLOW}ðŸš€ Starting Ollama...${NC}"
                    systemctl --user start ollama 2>/dev/null || ollama serve &
                    sleep 3
                fi
                ;;
        esac
    else
        echo -e "${YELLOW}âš ï¸  Ollama installation may have failed. Please install manually.${NC}"
    fi
}

# Function to download Ollama model
download_model() {
    MODEL=${DSO_MODEL:-llama3.1:8b}
    echo -e "${YELLOW}ðŸ“¥ Downloading AI model: $MODEL${NC}"
    echo -e "${YELLOW}   This may take a few minutes (model size: ~4.7 GB)...${NC}"
    
    if command_exists ollama; then
        ollama pull "$MODEL" || {
            echo -e "${YELLOW}âš ï¸  Model download failed. You can download it later with:${NC}"
            echo "   ollama pull $MODEL"
        }
    else
        echo -e "${YELLOW}âš ï¸  Ollama not available. Install it first, then run:${NC}"
        echo "   ollama pull $MODEL"
    fi
}

# Function to install security tools
install_security_tools() {
    echo -e "${YELLOW}ðŸ”§ Installing security tools (optional but recommended)...${NC}"
    
    INSTALL_TOOLS=false
    if [ "$1" = "--with-tools" ]; then
        INSTALL_TOOLS=true
    else
        read -p "Install security tools (Trivy, gitleaks, etc.)? (y/N): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            INSTALL_TOOLS=true
        fi
    fi
    
    if [ "$INSTALL_TOOLS" = false ]; then
        echo -e "${YELLOW}â­ï¸  Skipping tool installation. You can install them later with:${NC}"
        echo "   dso tools --install"
        return
    fi
    
    case "$OS" in
        darwin)
            if command_exists brew; then
                echo -e "${BLUE}Installing via Homebrew...${NC}"
                brew install trivy gitleaks || true
                brew install grype tfsec || true
            fi
            ;;
        linux)
            if [ -f /etc/debian_version ]; then
                # Trivy
                echo -e "${BLUE}Installing Trivy...${NC}"
                sudo apt-get update
                sudo apt-get install -y wget apt-transport-https gnupg lsb-release || true
                wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add - || true
                echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee /etc/apt/sources.list.d/trivy.list || true
                sudo apt-get update
                sudo apt-get install -y trivy || true
                
                # gitleaks
                echo -e "${BLUE}Installing gitleaks...${NC}"
                GITLEAKS_VERSION=$(curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest | grep tag_name | cut -d '"' -f 4)
                wget "https://github.com/gitleaks/gitleaks/releases/download/${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz" -O /tmp/gitleaks.tar.gz || true
                tar -xzf /tmp/gitleaks.tar.gz -C /tmp gitleaks || true
                sudo mv /tmp/gitleaks /usr/local/bin/ && sudo chmod +x /usr/local/bin/gitleaks || true
                
                # Grype
                echo -e "${BLUE}Installing Grype...${NC}"
                curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin || true
            else
                # Generic Linux
                echo -e "${BLUE}Installing via install scripts...${NC}"
                curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin || true
                curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin || true
            fi
            ;;
        windows)
            echo -e "${YELLOW}âš ï¸  Please install tools manually:${NC}"
            echo "   scoop install trivy grype gitleaks tfsec"
            echo "   Or: winget install AquaSecurity.Trivy"
            ;;
    esac
    
    echo -e "${GREEN}âœ… Security tools installation attempted${NC}"
}

# Function to build DSO
build_dso() {
    echo -e "${YELLOW}ðŸ”¨ Building DSO...${NC}"
    
    if [ ! -f "go.mod" ]; then
        echo -e "${RED}âŒ Not in DSO directory. Please run from the DSO repository root.${NC}"
        exit 1
    fi
    
    # Set build variables
    export CGO_ENABLED=0
    
    case "$OS" in
        darwin)
            if [ "$ARCH" = "arm64" ]; then
                GOOS=darwin GOARCH=arm64 go build -o dso .
            else
                GOOS=darwin GOARCH=amd64 go build -o dso .
            fi
            ;;
        linux)
            if [ "$ARCH" = "aarch64" ] || [ "$ARCH" = "arm64" ]; then
                GOOS=linux GOARCH=arm64 go build -o dso .
            else
                GOOS=linux GOARCH=amd64 go build -o dso .
            fi
            ;;
        windows)
            GOOS=windows GOARCH=amd64 go build -o dso.exe .
            ;;
    esac
    
    if [ -f "dso" ] || [ -f "dso.exe" ]; then
        chmod +x dso 2>/dev/null || true
        echo -e "${GREEN}âœ… DSO built successfully${NC}"
    else
        echo -e "${RED}âŒ Build failed${NC}"
        exit 1
    fi
}

# Function to install DSO globally
install_globally() {
    INSTALL_GLOBAL=false
    read -p "Install DSO globally? (y/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        INSTALL_GLOBAL=true
    fi
    
    if [ "$INSTALL_GLOBAL" = false ]; then
        echo -e "${YELLOW}â­ï¸  Skipping global installation${NC}"
        return
    fi
    
    case "$OS" in
        darwin|linux)
            if [ -f "dso" ]; then
                sudo cp dso /usr/local/bin/ || cp dso "$HOME/go/bin/" || cp dso "$HOME/.local/bin/"
                sudo chmod +x /usr/local/bin/dso 2>/dev/null || chmod +x "$HOME/go/bin/dso" 2>/dev/null || chmod +x "$HOME/.local/bin/dso" 2>/dev/null
                echo -e "${GREEN}âœ… DSO installed globally${NC}"
                echo -e "${BLUE}   Run: dso --version${NC}"
            fi
            ;;
        windows)
            echo -e "${YELLOW}âš ï¸  Please add dso.exe to your PATH manually${NC}"
            ;;
    esac
}

# Main installation flow
main() {
    # Check if we're in the right directory
    if [ ! -f "main.go" ] && [ ! -f "go.mod" ]; then
        echo -e "${YELLOW}ðŸ“¥ Cloning DSO repository...${NC}"
        if command_exists git; then
            git clone https://github.com/dso-cli/dso-cli.git /tmp/dso-install
            cd /tmp/dso-install
        else
            echo -e "${RED}âŒ Git not found. Please install git first.${NC}"
            exit 1
        fi
    fi
    
    # Step 1: Check/Install Go
    if ! command_exists go; then
        install_go
    else
        echo -e "${GREEN}âœ… Go found: $(go version)${NC}"
    fi
    echo ""
    
    # Step 2: Build DSO
    build_dso
    echo ""
    
    # Step 3: Check/Install Ollama
    if ! command_exists ollama; then
        install_ollama
    else
        echo -e "${GREEN}âœ… Ollama found${NC}"
    fi
    echo ""
    
    # Step 4: Download model
    if command_exists ollama; then
        if ollama list 2>/dev/null | grep -q "llama3.1:8b"; then
            echo -e "${GREEN}âœ… Model llama3.1:8b already installed${NC}"
        else
            download_model
        fi
    fi
    echo ""
    
    # Step 5: Install security tools (optional)
    install_security_tools "$@"
    echo ""
    
    # Step 6: Global installation (optional)
    install_globally
    echo ""
    
    # Final message
    echo -e "${GREEN}ðŸŽ‰ Installation completed!${NC}"
    echo ""
    echo -e "${BLUE}To use DSO:${NC}"
    if [ -f "dso" ]; then
        echo -e "  ${GREEN}./dso audit .${NC}"
    elif [ -f "dso.exe" ]; then
        echo -e "  ${GREEN}.\dso.exe audit .${NC}"
    fi
    echo ""
    echo -e "${BLUE}Verify installation:${NC}"
    echo -e "  ${GREEN}./dso check${NC}        # Check Ollama"
    echo -e "  ${GREEN}./dso tools${NC}       # Check scanners"
    echo ""
}

# Run main function
main "$@"

